# Component Analysis Pipeline

This repository contains a analytical pipeline for processing single-cell data using Non-negative Matrix Factorization (cNMF). It facilitates the identification of gene programs and performs downstream functional enrichment analyses including Over-Representation Analysis (ORA) and Gene Set Enrichment Analysis (GSEA).

## Repository Structure

### Key Notebooks & Scripts
*   **`runNMF.ipynb`**: Primary notebook for running Consensus NMF (cNMF) on single-cell data (AnnData/H5AD format). It handles:
    *   Data loading and preprocessing.
    *   Iterative NMF factorization.
    *   Consensus clustering and K-selection (visualization of stability vs. error).
*   **`de_program_analysis.ipynb`**: Analyzes differentially expressed (DE) genes in the context of the identified cNMF programs. It correlates program usage with sample conditions or guide perturbations.
*   **`runORA.py` / `runORA.ipynb`**: Performs Over-Representation Analysis (ORA) using `gseapy`. It takes the top-weighted genes from each cNMF program and tests for enrichment against gene sets (e.g., GO, KEGG).
*   **`runGSEA.py` / `runGSEA.ipynb`**: Performs Gene Set Enrichment Analysis (GSEA) using `gseapy`. It uses the full spectrum of gene weights for each program (ranked list) to identify enriched pathways.
*   **`upsetPlot.ipynb`**: Generates UpSet plots to visualize the intersections and overlaps of gene programs or DE gene sets across different comparisons.
*   **`matchGuides.ipynb`**: Analyzes the relationship between CRISPR guides and the identified cell programs, likely for mapping Guide-to-Phenotype relationships.

### Directories
*   **`data/`**: Storage for input datasets (e.g., `.h5ad` SingleCell objects, DE results in `.csv` format).
*   **`results/`**: Output directory for cNMF results, figures, and enrichment tables.
*   **`de_gsea_ora/`**: Helper directory containing intermediate files or scripts specifically for the DE and functional enrichment workflows.

## Dependencies

The pipeline relies on a Python environment (e.g., via Conda) with the following key libraries:

*   **`scanpy`**: Single-cell analysis framework.
*   **`cnmf`**: The cNMF algorithm implementation (likely [dylkot/cNMF](https://github.com/dylkot/cNMF)).
*   **`gseapy`**: For ORA and GSEA enrichment analyses.
*   **`upsetplot`**: For intersection visualizations.
*   `pandas`, `numpy`, `matplotlib`, `tqdm`.

## Analysis Workflow

1.  **Data Preparation & Factorization (`runNMF.ipynb`)**:
    *   Load your single-cell data (`.h5ad`).
    *   Configure cNMF parameters (number of components `K`, number of iterations).
    *   Run factorization to generate Usage (Cells x Programs) and Spectra (Programs x Genes) matrices.
    *   Select the optimal `K` using stability plots.

2.  **Downstream Characterization**:
    *   **Functional Annotation**: Use `runORA.py` (top genes) or `runGSEA.py` (ranked spectra) to assign biological meaning to the latent programs.
    *   **Differential Analysis**: Use `de_program_analysis.ipynb` to integrate differential expression results with the discovered programs.

3.  **Visualization**:
    *   Explore program usage across disparate groups.
    *   Use `upsetPlot.ipynb` to view shared gene content between programs or conditions.

## Outputs

*   **cNMF Results**: Factorization files in `results/cnmf_run/`.
*   **Enrichment Tables**: CSV files containing pathway enrichment statistics (p-values, FDR, NES) generated by ORA and GSEA steps.
